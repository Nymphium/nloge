<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Nloge (nloge.Nloge)</title><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">nloge</a> &#x00BB; Nloge</nav><header class="odoc-preamble"><h1>Module <code><span>Nloge</span></code></h1><p>Nloge is a asynchronous logger with Eio.</p><p>By default nloge logs with JSON format:</p><pre class="language-ocaml"><code>let () =
  Eio_main.run @@ fun env -&gt;
  Eio.Switch.run @@ fun sw -&gt;
  Nloge.run ~clock:env#clock ~sw ~outputs:[ env#stdout ] ~level:`Debug @@ fun () -&gt;
  Nloge.debug
    ~__LOC__
    ~metadata:[ &quot;now_posix&quot;, `Float (Eio.Time.now env#clock) ]
    (fun m -&gt; m &quot;hello&quot;)

(* {&quot;log_level&quot;:&quot;DEBUG&quot;,&quot;message&quot;:&quot;hello&quot;,&quot;label&quot;:&quot;File \&quot;examples/hello.ml\&quot;, line 9, characters 5-12&quot;,&quot;now_posix&quot;:1683056241.957986} *)
;;</code></pre><ul class="at-tags"><li class="see"><span class="at-tag">see</span> <a href="https://github.com/nymphium/nloge/blob/master/examples" class="value">https://github.com/nymphium/nloge/blob/master/examples</a> <p>for more examples</p></li></ul></header><nav class="odoc-toc"><ul><li><a href="#writer">Writing logs</a></li><li><a href="#emit">Emitting log</a><ul><li><a href="#log-functions">Log functions</a></li><li><a href="#utilities">Utilities</a></li></ul></li><li><a href="#level">Log Level and utilities</a></li></ul></nav><div class="odoc-content"><h2 id="writer"><a href="#writer" class="anchor"></a>Writing logs</h2><p>Nloge writes logs, given by <a href="#extension-Emit"><code>Emit</code></a> effect, to <code>Eio.Flow.sink</code></p><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Write"><a href="#extension-decl-Write" class="anchor"></a><code><span><span class="keyword">type</span> <span class="xref-unresolved">Stdlib</span>.Effect.t += </span></code><ol><li id="extension-Write" class="def extension anchored"><a href="#extension-Write" class="anchor"></a><code><span>| </span><span><span class="extension">Write</span> : string * <a href="Level/index.html#type-t">Level.t</a> <span class="arrow">&#45;&gt;</span> <span>unit <span class="xref-unresolved">Stdlib</span>.Effect.t</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write"><a href="#val-write" class="anchor"></a><code><span><span class="keyword">val</span> write : <span><a href="Level/index.html#type-t">Level.t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Trans"><a href="#module-Trans" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Trans/index.html">Trans</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : 
  <span>clock:<span class="xref-unresolved">Eio</span>.Time.clock <span class="arrow">&#45;&gt;</span></span>
  <span>sw:<span class="xref-unresolved">Eio__core</span>.Switch.t <span class="arrow">&#45;&gt;</span></span>
  <span>outputs:<span><span class="xref-unresolved">Eio</span>.Flow.sink list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>level:<a href="Level/index.html#type-t">Level.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?trans:<span>(<span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'r0</span></span></code></div><div class="spec-doc"><p><code>run</code> is the handler to write logs to given outputs.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">clock</span> <p><code>Eio.Time.clock</code> clock objet</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">sw</span> <p><code>Eio.Switch.t</code> switch object to write output asynchronously</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">outputs</span> <p><code>Eio.Flow.sink list</code> the targets to write logs</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">level</span> <p><code>Level.t option</code></p></li></ul></div></div><h2 id="emit"><a href="#emit" class="anchor"></a>Emitting log</h2><p>Nloge &quot;emit&quot;s logs to <a href="#writer">Writing logs</a> by &quot;perform&quot;ing <a href="#extension-Emit"><code>Emit</code></a>.</p><div class="odoc-spec"><div class="spec type anchored" id="type-msgf"><a href="#type-msgf" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a msgf</span></span><span> =
  <span><span>(<span><span><span>(<span class="type-var">'a</span>, <span class="xref-unresolved">Stdlib</span>.Format.formatter, unit, unit)</span> <span class="xref-unresolved">Stdlib</span>.format4</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-metadata"><a href="#type-metadata" class="anchor"></a><code><span><span class="keyword">type</span> metadata</span><span> = <span><span>(string * <span class="xref-unresolved">Yojson</span>.Safe.t)</span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span><span> = <a href="Level/index.html#type-t">Level.t</a> * <span>string option</span> * <a href="#type-metadata">metadata</a> * <span><span class="type-var">'a</span> <a href="#type-msgf">msgf</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Emit"><a href="#extension-decl-Emit" class="anchor"></a><code><span><span class="keyword">type</span> <span class="xref-unresolved">Stdlib</span>.Effect.t += </span></code><ol><li id="extension-Emit" class="def extension anchored"><a href="#extension-Emit" class="anchor"></a><code><span>| </span><span><span class="extension">Emit</span> : <span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span> <span>unit <span class="xref-unresolved">Stdlib</span>.Effect.t</span></span></code></li></ol></div><div class="spec-doc"><p><code>Emit</code> is aimed to emit log objects. <a href="#writer">Writing logs</a> can be injected to handle the effect.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-logger"><a href="#type-logger" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a logger</span></span><span> = <span>?metadata:<a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> <span>?__LOC__:string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-msgf">msgf</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><h3 id="log-functions"><a href="#log-functions" class="anchor"></a>Log functions</h3><div class="odoc-spec"><div class="spec value anchored" id="val-emit"><a href="#val-emit" class="anchor"></a><code><span><span class="keyword">val</span> emit : <span><a href="Level/index.html#type-t">Level.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-msgf">msgf</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>string option</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>emit level ?metadata ?loc msgf</code> sends <code>msgf</code> message object with level <code>level</code>. <code>metadata</code> and <code>loc</code> can be sent optionally.</p><pre class="language-ocaml"><code>emit `Debug @@ fun m -&gt; m &quot;hello, %s&quot; &quot;world&quot; (* -&gt; hello, world *) </code></pre><p>And the following <code>emg</code>, <code>alert</code>, etc. are wrapper for <code>emit</code> with correspondng <code>level</code>.</p><pre class="language-ocaml"><code>debug ~metadata:[&quot;Key&quot;, `String &quot;Val&quot; ] ~__LOC__ @@ fun m -&gt; m &quot;the answer: %d&quot; 42 </code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-emg"><a href="#val-emg" class="anchor"></a><code><span><span class="keyword">val</span> emg : <span><span class="type-var">'a</span> <a href="#type-logger">logger</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-alert"><a href="#val-alert" class="anchor"></a><code><span><span class="keyword">val</span> alert : <span><span class="type-var">'a</span> <a href="#type-logger">logger</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-crit"><a href="#val-crit" class="anchor"></a><code><span><span class="keyword">val</span> crit : <span><span class="type-var">'a</span> <a href="#type-logger">logger</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-err"><a href="#val-err" class="anchor"></a><code><span><span class="keyword">val</span> err : <span><span class="type-var">'a</span> <a href="#type-logger">logger</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-warn"><a href="#val-warn" class="anchor"></a><code><span><span class="keyword">val</span> warn : <span><span class="type-var">'a</span> <a href="#type-logger">logger</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-notice"><a href="#val-notice" class="anchor"></a><code><span><span class="keyword">val</span> notice : <span><span class="type-var">'a</span> <a href="#type-logger">logger</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-info"><a href="#val-info" class="anchor"></a><code><span><span class="keyword">val</span> info : <span><span class="type-var">'a</span> <a href="#type-logger">logger</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-debug"><a href="#val-debug" class="anchor"></a><code><span><span class="keyword">val</span> debug : <span><span class="type-var">'a</span> <a href="#type-logger">logger</a></span></span></code></div></div><h3 id="utilities"><a href="#utilities" class="anchor"></a>Utilities</h3><div class="odoc-spec"><div class="spec value anchored" id="val-make_emit_handler"><a href="#val-make_emit_handler" class="anchor"></a><code><span><span class="keyword">val</span> make_emit_handler : 
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>float <span class="arrow">&#45;&gt;</span></span> <span><a href="Level/index.html#type-t">Level.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>string option</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'r0</span></span></code></div><div class="spec-doc"><p><code>make_emit_handler</code> is a utility to build a handler for <a href="#extension-Emit"><code>Emit</code></a>.</p><pre class="language-ocaml"><code>let plain_transformer f =
  Nloge.make_emit_handler f
  @@ fun now level loc metadata msg -&gt;
  let json = Nloge.Trans.insert_info now level loc msg metadata in
  let len = List.length json in
  let k0 = Format.kasprintf (Nloge.write level) &quot;%a:\n%s&quot; Nloge.Level.pp level in
  let k, _ =
    ListLabels.fold_left json ~init:(k0, 0) ~f:(fun (k, idx) (label, v) -&gt;
      let idx' = idx + 1 in
      let comma = if idx' = len then &quot;&quot; else &quot;\n&quot; in
      ( Format.kasprintf
          k
          &quot;\t%-10s = %a%s%s&quot;
          label
          (Yojson.Safe.pretty_print ~std:true)
          v
          comma
      , idx' ))
  in
  k &quot;\n&quot;
;;</code></pre></div></div><h2 id="level"><a href="#level" class="anchor"></a>Log Level and utilities</h2><div class="odoc-spec"><div class="spec module anchored" id="module-Level"><a href="#module-Level" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Level/index.html">Level</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>